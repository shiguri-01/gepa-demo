import { google } from "@ai-sdk/google";
import { Agent } from "@mastra/core/agent";
import { LibSQLStore } from "@mastra/libsql";
import { Memory } from "@mastra/memory";
import type { TaskItem } from "../../gepa/task";

const instructions = `
あなたの使命は、AIアシスタントの論理的思考能力を、以下の原則に基づき、絶対的な公平性をもって評価することです。あなたは解答の表面的な正しさだけでなく、その結論に至るまでの思考プロセスの健全性を見抜く、鋭い分析眼を持つ専門家です。

### 基本原則
1.  **思考プロセス最優先:** 最終的な答えが正しくても、その過程に論理的飛躍、矛盾、条件の見落としがあれば、それは不完全な解答です。評価の主眼は常に思考プロセスに置かれます。
2.  **客観性と具体性:** 評価はあなたの主観であってはなりません。必ず後述の【評価基準】に厳密に従い、フィードバックでは「なぜ」その評価になったのかを、AIの解答の具体的な部分を引用して説明してください。
3.  **厳格な出力形式:** 出力は指定されたJSONスキーマに完全に従う必要があります。思考過程や挨拶など、指定外のテキストは一切含めてはなりません。

### 評価実行手順 (Step-by-Step)
あなたは以下のステップに従って、思考し、評価を実行してください。
1.  **インプット理解:** \`question\`（問題文）、\`expectedAnswer\`（模範解答）、\`aiAnswer\`（思考過程を含むAIの解答）、\`questionExplanation\`（質問の意図や解答のポイントに関する補足説明）を深く理解します。特に問題文に含まれる条件や制約をすべてリストアップします。質問の説明から、出題者の意図や重要視しているポイントを把握します。
2.  **思考プロセス分析:** \`aiAnswer\`をステップごとに分解します。各ステップが、問題の条件と論理法則に整合しているか、計算ミスや見落としがないかを精査します。
3.  **最終解答比較:** \`aiAnswer\`の最終的な結論を\`expectedAnswer\`と比較し、その正確性を判断します。意味的に同等であれば正確とみなします。
4.  **スコアリング:** 以下の【評価基準】に、ステップ2と3の分析結果を照らし合わせ、最も合致するスコアを一つだけ選択します。
5.  **フィードバック作成:** 決定したスコアの根拠を、具体的かつ建設的に記述します。
    *   **良い点:** 論理的に正しかった部分や、優れた洞察があった場合は簡潔に言及します。
    *   **問題点:** 誤りがあった場合、どのステップで、どのような誤り（例: 計算ミス, 条件の見落とし, 論理の飛躍）があったのかを明確に指摘します。可能であれば、正しい考え方や計算を示します。
6.  **JSON出力:** 最終的なスコアとフィードバックを指定されたJSON形式で出力します。

### 【評価基準】 (Scoring Rubric)
以下のステップに従って評価を行い、最終的なスコアを決定してください。

**ステップ1：各軸を3段階で評価**

| 評価軸 | 2点 (Good) | 1点 (Fair) | 0点 (Poor) |
| :--- | :--- | :--- | :--- |
| **A: 思考プロセス** | 論理的で矛盾がない | 一部の欠陥や見落としがある | 重大な欠陥、または破綻している |
| **B: 最終的な答え** | 完全に正確 | 大筋は正しいが、誤りを含む | 明確に不正確、または的外れ |

**ステップ2：合計点による最終スコアの決定**

| 合計点 (A+B) | 最終スコア | 解説 |
| :--- | :--- | :--- |
| **4点** | **1.0** | 思考プロセス、答え共に完璧。 |
| **3点** | **0.8** | 思考プロセスか答えのどちらかに、軽微な欠陥がある。 |
| **2点** | **0.6** | 思考プロセス、答えの両方に欠陥があるが、部分的には評価できる。または、片方が著しく良いが、もう片方が悪い（例：思考は完璧だが答えが間違い）。 |
| **1点** | **0.4** | 思考プロセスか答えのどちらかに、重大な欠陥がある。 |
| **0点** | **0.2** | 思考プロセス、答えの両方に重大な欠陥がある。 |
| **-** | **0.0** | 「無回答」「無関係」「有害」など、評価の土台に乗らない場合。 |
`.trim();

export const logicalEvaluationAgent = new Agent({
  name: "Logical Evaluation Agent",
  instructions: instructions,
  model: google("gemini-2.5-flash"),
  memory: new Memory({
    storage: new LibSQLStore({
      url: "file:../mastra.db",
    }),
  }),
});

export const logicalThinkingTask: TaskItem[] = [
  {
    id: "1",
    category: "算術推論",
    question:
      "文房具店で、太郎君は150円のペンを1本と、80円の消しゴムを2個買いました。彼が500円玉で支払った場合、お釣りはいくらになりますか？",
    answer: "190円",
    explanation: `
*   **思考プロセス:**
    1.  消しゴムの合計金額を計算する: 80円 × 2個 = 160円
    2.  買い物の合計金額を計算する: 150円 (ペン) + 160円 (消しゴム) = 310円
    3.  お釣りを計算する: 500円 - 310円 = 190円
*   **最終的な答え:** 190円
      `.trim(),
  },
  {
    id: "2",
    category: "算術推論",
    question:
      "全200ページの小説を読んでいます。昨日までに50ページ読みました。今日は昨日の倍のページ数を読みました。読み終えるには、あと何ページ残っていますか？",
    answer: "50ページ",
    explanation: `
*   **思考プロセス:**
    1.  今日読んだページ数を計算する: 50ページ × 2 = 100ページ
    2.  読み終えた合計ページ数を計算する: 50ページ (昨日) + 100ページ (今日) = 150ページ
    3.  残りのページ数を計算する: 200ページ - 150ページ = 50ページ
*   **最終的な答え:** 50ページ
      `.trim(),
  },
  {
    id: "3",
    category: "算術推論",
    question:
      "バスケットにリンゴが12個入っていました。Aさんがそのうちの3分の1を取り、Bさんが残りの半分を取りました。バスケットには今、何個のリンゴが残っていますか？",
    answer: "4個",
    explanation: `
  *   **思考プロセス:**
      1.  Aさんが取ったリンゴの数を計算する: 12個 × (1/3) = 4個
      2.  Aさんが取った後の残りのリンゴの数を計算する: 12個 - 4個 = 8個
      3.  Bさんが取ったリンゴの数を計算する: 8個 × (1/2) = 4個
      4.  最終的に残ったリンゴの数を計算する: 8個 - 4個 = 4個
  *   **最終的な答え:** 4個
        `.trim(),
  },
  {
    id: "4",
    category: "算術推論",
    question:
      "クッキーを焼くのに、1つのバッチで10枚作れます。クラスの生徒23人全員に1枚ずつ配るには、最低何回バッチを焼く必要がありますか？",
    answer: "3回",
    explanation: `
  *   **思考プロセス:**
      1.  必要なクッキーの総数は23枚。
      2.  1バッチで10枚作れる。
      3.  1回焼くと10枚 (足りない)。
      4.  2回焼くと20枚 (まだ足りない)。
      5.  3回焼くと30枚 (全員に配れる)。
      6.  したがって、最低3回焼く必要がある。
  *   **最終的な答え:** 3回
        `.trim(),
  },
  {
    id: "5",
    category: "時間・順序推論",
    question:
      "現在時刻は午後2時40分です。45分後に始まる映画を見に行きたいです。映画館まで歩いて20分かかります。映画が始まる何分前に家を出れば、開始時刻ちょうどに到着しますか？",
    answer: "午後3時5分",
    explanation: `
*   **思考プロセス:**
    1.  映画の開始時刻を計算する: 午後2時40分 + 45分 = 午後3時25分
    2.  映画館への移動時間は20分。
    3.  開始時刻ちょうどに到着するには、開始時刻の20分前に家を出る必要がある。
    4.  出発時刻を計算する: 午後3時25分 - 20分 = 午後3時5分
*   **最終的な答え:** 午後3時5分
      `.trim(),
  },
  {
    id: "6",
    category: "時間・順序推論",
    question:
      "あるイベントは午前10時に始まり、途中で15分の休憩を2回挟み、午後1時に終わりました。休憩を除いたイベントの実質的な時間は何時間何分でしたか？",
    answer: "2時間30分",
    explanation: `
*   **思考プロセス:**
    1.  イベントの総時間を計算する: 午前10時から午後1時までは3時間。
    2.  休憩の合計時間を計算する: 15分 × 2回 = 30分
    3.  実質的な時間を計算する: 3時間 - 30分 = 2時間30分
*   **最終的な答え:** 2時間30分
      `.trim(),
  },
  {
    id: "7",
    category: "時間・順序推論",
    question:
      "A、B、Cの3つのタスクがあります。Aは10分かかり、BはAが終わってから5分後に開始でき、B自体は15分かかります。CはBの開始と同時に開始でき、20分かかります。全てのタスクが完了するのは、Aの開始から最短で何分後ですか？",
    answer: "35分後",
    explanation: `
  *   **思考プロセス:**
      1.  Aの終了時刻: 開始から10分後。
      2.  Bの開始時刻: Aの終了(10分後) + 5分後 = 開始から15分後。
      3.  Bの終了時刻: Bの開始(15分後) + 15分 = 開始から30分後。
      4.  Cの開始時刻: Bの開始と同じなので、開始から15分後。
      5.  Cの終了時刻: Cの開始(15分後) + 20分 = 開始から35分後。
      6.  全てのタスクが終わるのは、BとCが終わる時刻のうち遅い方。30分後と35分後なので、35分後。
  *   **最終的な答え:** 35分後
        `.trim(),
  },
  {
    id: "8",
    category: "時間・順序推論",
    question: "4月5日は金曜日でした。その月の第4日曜日は何日ですか？",
    answer: "4月28日",
    explanation: `
  *   **思考プロセス:**
      1.  4月5日が金曜日なので、2日後の4月7日が最初の日曜日（第1日曜日）。
      2.  第2日曜日は、その7日後なので、7 + 7 = 14日。
      3.  第3日曜日は、さらに7日後なので、14 + 7 = 21日。
      4.  第4日曜日は、さらに7日後なので、21 + 7 = 28日。
  *   **最終的な答え:** 4月28日
        `.trim(),
  },
  {
    id: "9",
    category: "空間推論",
    question:
      "本棚に左から順に赤、青、緑、黄色の本が並んでいます。まず、赤と緑の本を入れ替えました。次に、新しい並び順で一番右にある本と一番左にある本を入れ替えました。最終的に、左から2番目にある本の色は何色ですか？",
    answer: "青",
    explanation: `
*   **思考プロセス:**
    1.  初期状態: [赤, 青, 緑, 黄]
    2.  赤と緑を入れ替える: [緑, 青, 赤, 黄]
    3.  一番右(黄)と一番左(緑)を入れ替える: [黄, 青, 赤, 緑]
    4.  最終的な並びで左から2番目は「青」。
*   **最終的な答え:** 青
      `.trim(),
  },
  {
    id: "10",
    category: "空間推論",
    question:
      "あなたは公園の入り口にいて、北を向いています。まっすぐ100m進み、そこから右に曲がって50m進みました。次に左に曲がってさらに50m進みました。今、あなたは入り口から見て、どの方向（例：北東）にいますか？",
    answer: "北東",
    explanation: `
*   **思考プロセス:**
    1.  最初、北に100m進む。現在位置は入り口の真北。
    2.  右（東）に曲がって50m進む。現在位置は入り口から見て北東方向。
    3.  左（北）に曲がって50m進む。さらに北へ移動する。
    4.  最終的な位置は、入り口から北方向と東方向に移動した場所なので、北東方向。
*   **最終的な答え:** 北東
      `.trim(),
  },
  {
    id: "11",
    category: "空間推論",
    question:
      "円卓にA, B, C, Dの4人が座っています。Aの正面にはCが座っています。Aの右隣がBのとき、Cの左隣は誰ですか？",
    answer: "D",
    explanation: `
  *   **思考プロセス:**
      1.  円卓をイメージする。4つの席がある。
      2.  Aを一つの席に置く。その正面がC。
      3.  Aの右隣がB。
      4.  残りの席は1つで、Cの左隣になる。そこに入るのはD。
      5.  配置：(時計回りに) A, B, C, D。Cの左隣はDとなる。
      6.  もう一度整理。Aを12時の位置に置く。Cは6時の位置。Aの右隣（時計回りの3時）がB。残りの9時の位置がD。C（6時）から見て、左隣（9時）はD。
  *   **最終的な答え:** D
        `.trim(),
  },
  {
    id: "12",
    category: "空間推論",
    question:
      "箱の中に、3つの赤いボールと4つの青いボールが入っています。この箱に、2つの赤いボールと1つの青いボールを追加しました。その後、箱から青いボールを2つ取り出しました。最終的に箱の中にある赤いボールの数は、青いボールの数よりいくつ多いですか？",
    answer: "2つ多い",
    explanation: `
  *   **思考プロセス:**
      1.  初期状態: 赤3, 青4
      2.  ボールを追加: 赤(3+2)=5, 青(4+1)=5
      3.  青いボールを取り出す: 赤5, 青(5-2)=3
      4.  差を計算する: 赤5 - 青3 = 2
  *   **最終的な答え:** 2つ多い
        `.trim(),
  },
  {
    id: "13",
    category: "論理パズル",
    question:
      "犬、猫、鳥を飼っているP, Q, Rの3人がいます。それぞれのペットは異なります。Qは猫でも犬でもありません。Pは猫を飼っていません。Rが飼っているペットは何ですか？",
    answer: "猫",
    explanation: `
*   **思考プロセス (修正後):**
    1. ペットは犬、猫、鳥。飼い主はP, Q, Rで、ペットはそれぞれ異なる。
    2. 「Qは猫でも犬でもない」ので、Qのペットは鳥で確定。
    3. 残りのペットは犬と猫。飼い主はPとR。
    4. 「Pは猫を飼っていない」ので、Pのペットは犬で確定。
    5. 残ったペットは猫。残った飼い主はR。よって、Rのペットは猫。
*   **最終的な答え (修正後):** 猫
      `.trim(),
  },
  {
    id: "14",
    category: "論理パズル",
    question:
      "3つのスイッチがあり、それぞれが別の部屋にある電球A, B, Cのいずれか1つに対応しています。どのスイッチがどの電球に対応しているか調べるために、一度だけ部屋に入ることができます。どのように操作すれば、全ての対応関係が分かりますか？",
    answer:
      "スイッチ1をONにして数分待ちOFF、スイッチ2をONにして部屋に入り、電球の明かりと温度を確認する。",
    explanation: `
  *   **思考プロセス:**
      1.  目的は、1回の部屋への訪問で3つのスイッチと3つの電球の対応を特定すること。
      2.  スイッチの操作で、電球に3つの異なる状態を作り出す必要がある。
      3.  状態1: スイッチ1をONにして数分待つ。
      4.  状態2: スイッチ1をOFFにして、すぐにスイッチ2をONにする。
      5.  状態3: スイッチ3は触らない（OFFのまま）。
      6.  この状態で部屋に入る。
      7.  結果の確認：
          - 点灯している電球 → スイッチ2に対応。
          - 消えているが、触ると温かい電球 → スイッチ1に対応。
          - 消えていて、冷たい電球 → スイッチ3に対応。
  *   **最終的な答え:** スイッチ1をONにして数分待ちOFF、スイッチ2をONにして部屋に入り、電球の明かりと温度を確認する。
        `.trim(),
  },
  {
    id: "15",
    category: "論理パズル",
    question: "今日が水曜日だとすると、昨日から数えて5日前は何曜日ですか？",
    answer: "木曜日",
    explanation: `
  *   **思考プロセス:**
      1.  今日が水曜日。
      2.  昨日は火曜日。
      3.  昨日（火曜日）から数えて5日前を計算する。
      4.  1日前: 月曜日, 2日前: 日曜日, 3日前: 土曜日, 4日前: 金曜日, 5日前: 木曜日。
  *   **最終的な答え:** 木曜日
        `.trim(),
  },
  {
    id: "16",
    category: "条件分岐",
    question:
      "ある図書館では、本の返却が期限を過ぎると延滞料金がかかります。料金は、最初の3日間は1日50円、4日目以降は1日80円です。もし本をちょうど5日間延滞した場合、延滞料金は合計でいくらになりますか？",
    answer: "310円",
    explanation: `
*   **思考プロセス:**
    1.  延滞日数は5日間。
    2.  最初の3日間の料金を計算する: 3日間 × 50円/日 = 150円
    3.  4日目以降の延滞日数を計算する: 5日間 - 3日間 = 2日間
    4.  4日目以降の料金を計算する: 2日間 × 80円/日 = 160円
    5.  合計料金を計算する: 150円 + 160円 = 310円
*   **最終的な答え:** 310円
      `.trim(),
  },
  {
    id: "17",
    category: "条件分岐",
    question:
      "オンラインショップで買い物をします。商品の合計金額が5,000円未満の場合、送料が500円かかります。5,000円以上の場合、送料は無料です。もし、3,000円の商品と2,500円の商品を買った場合、支払う総額はいくらになりますか？",
    answer: "5,500円",
    explanation: `
  *   **思考プロセス:**
      1.  商品の合計金額を計算する: 3,000円 + 2,500円 = 5,500円
      2.  条件を確認する: 合計金額は5,000円以上か？ → はい、5,500円は5,000円以上。
      3.  条件に基づいて送料を決定する: 送料無料（0円）。
      4.  支払う総額を計算する: 5,500円 (商品代金) + 0円 (送料) = 5,500円
  *   **最終的な答え:** 5,500円
        `.trim(),
  },
  {
    id: "18",
    category: "条件分岐",
    question:
      "テストの点数が80点以上なら「合格」、60点以上80点未満なら「再テスト」、60点未満なら「不合格」となります。Aさんは75点、Bさんは59点でした。それぞれの結果は何ですか？",
    answer: "Aさんは「再テスト」、Bさんは「不合格」",
    explanation: `
  *   **思考プロセス:**
      1.  Aさんの点数(75点)を評価する。
      2.  80点以上ではない。60点以上80点未満である。したがって、Aさんは「再テスト」。
      3.  Bさんの点数(59点)を評価する。
      4.  60点未満である。したがって、Bさんは「不合格」。
  *   **最終的な答え:** Aさんは「再テスト」、Bさんは「不合格」
        `.trim(),
  },
  {
    id: "19",
    category: "状態変化の追跡",
    question:
      "目の前に赤、青、緑の3つのボタンがあります。赤いボタンを押すと、青いランプが点灯します。青いボタンを押すと、緑のランプが点灯します。緑のボタンを押すと、点灯しているすべてのランプが消えます。最初に、赤いボタンを押し、次に青いボタンを押しました。最後に点灯しているランプの色は何色ですか？",
    answer: "青と緑",
    explanation: `
*   **思考プロセス:**
    1.  初期状態: 全てのランプは消灯している。
    2.  操作1: 赤いボタンを押す。→ 青いランプが点灯する。現在の状態: [青]
    3.  操作2: 青いボタンを押す。→ 緑のランプが点灯する。現在の状態: [青, 緑]
    4.  最終的に点灯しているランプは青と緑。
*   **最終的な答え:** 青と緑
      `.trim(),
  },
  {
    id: "20",
    category: "状態変化の追跡",
    question:
      "部屋に電気がついています。スイッチを1回押すと電気が消えます。もう1回押すとつきます。このスイッチを合計で5回押しました。最終的に、部屋の電気はついていますか、それとも消えていますか？",
    answer: "消えている",
    explanation: `
  *   **思考プロセス:**
      1.  初期状態: ついている (ON)
      2.  1回目: 消える (OFF)
      3.  2回目: つく (ON)
      4.  3回目: 消える (OFF)
      5.  4回目: つく (ON)
      6.  5回目: 消える (OFF)
      7.  奇数回押すと状態が反転し、偶数回押すと元の状態に戻る。初期がONなので、奇数回押した後はOFFになる。
  *   **最終的な答え:** 消えている
        `.trim(),
  },
] as const;
